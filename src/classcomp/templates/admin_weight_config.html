<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>权重配置 - 信息委员评分系统</title>
    <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='custom.css') }}" rel="stylesheet">
    <style>
        .weight-indicator {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        .config-card {
            border-left: 4px solid #667eea;
        }
        .config-card.active {
            background-color: #f0f4ff;
            border-left-color: #28a745;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-clipboard-check me-2"></i>
                信息委员评分系统
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    欢迎，{{ user.username }}
                </span>
                <a class="nav-link" href="{{ url_for('admin') }}">
                    <i class="fas fa-cog me-1"></i>管理面板
                </a>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt me-1"></i>退出
                </a>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <h2 class="mb-4">
            <i class="fas fa-balance-scale me-2"></i>
            评分权重配置
        </h2>

        <!-- 说明面板 -->
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle me-2"></i>权重配置说明</h5>
            <ul class="mb-0">
                <li>权重值范围：1.0 - 5.0</li>
                <li>新媒体委员评分权重建议设置为 1.5 或更高，以体现其抽查的重要性</li>
                <li>信息委员评分权重通常为 1.0（基准权重）</li>
                <li>系统计算班级平均分时会自动应用权重</li>
                <li>只有标记为"活跃"的配置会被实际使用</li>
            </ul>
        </div>

        <!-- 当前活跃配置 -->
        <div class="card card-custom mb-4">
            <div class="card-header card-header-custom">
                <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>当前活跃配置</h5>
            </div>
            <div class="card-body">
                {% if active_config %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="text-center p-3 border rounded">
                            <h6>新媒体委员权重</h6>
                            <div class="weight-indicator">{{ active_config.new_media_weight }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center p-3 border rounded">
                            <h6>信息委员权重</h6>
                            <div class="weight-indicator">{{ active_config.info_commissioner_weight }}</div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <p class="mb-1"><strong>配置名称：</strong>{{ active_config.config_name }}</p>
                    <p class="mb-0"><strong>描述：</strong>{{ active_config.description or '无' }}</p>
                </div>
                {% else %}
                <p class="text-muted mb-0">未找到活跃配置，系统将使用默认权重（新媒体委员：1.5，信息委员：1.0）</p>
                {% endif %}
            </div>
        </div>

        <!-- 创建新配置 -->
        <div class="card card-custom mb-4">
            <div class="card-header card-header-custom">
                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>创建新配置</h5>
            </div>
            <div class="card-body">
                <form id="createConfigForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">配置名称 *</label>
                            <input type="text" class="form-control" name="config_name" required maxlength="100">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">新媒体委员权重 *</label>
                            <input type="number" class="form-control" name="new_media_weight" 
                                   min="1.0" max="5.0" step="0.1" value="1.5" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">信息委员权重 *</label>
                            <input type="number" class="form-control" name="info_commissioner_weight" 
                                   min="1.0" max="5.0" step="0.1" value="1.0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">立即激活</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="is_active" id="activateCheck">
                                <label class="form-check-label" for="activateCheck">
                                    创建后立即设为活跃配置
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">描述（可选）</label>
                        <textarea class="form-control" name="description" rows="2" maxlength="200"></textarea>
                    </div>
                    <button type="submit" class="btn btn-custom">
                        <i class="fas fa-save me-2"></i>创建配置
                    </button>
                </form>
            </div>
        </div>

        <!-- 所有配置列表 -->
        <div class="card card-custom">
            <div class="card-header card-header-custom">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>所有配置</h5>
            </div>
            <div class="card-body">
                <div id="configsList">
                    <!-- 动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            loadConfigs();
        });

        function loadConfigs() {
            $.get('/api/weight_configs', function(response) {
                if (response.success) {
                    displayConfigs(response.configs);
                }
            }).fail(function() {
                alert('加载配置失败');
            });
        }

        function displayConfigs(configs) {
            if (configs.length === 0) {
                $('#configsList').html('<p class="text-muted">暂无配置</p>');
                return;
            }

            let html = '';
            configs.forEach(config => {
                const activeClass = config.is_active ? 'active' : '';
                const activeBadge = config.is_active ? '<span class="badge bg-success">活跃</span>' : '';
                
                html += `
                    <div class="card config-card ${activeClass} mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6>${config.config_name} ${activeBadge}</h6>
                                    <p class="text-muted mb-2">${config.description || '无描述'}</p>
                                    <div class="row">
                                        <div class="col-auto">
                                            <small>新媒体权重: <strong>${config.new_media_weight}</strong></small>
                                        </div>
                                        <div class="col-auto">
                                            <small>信息委员权重: <strong>${config.info_commissioner_weight}</strong></small>
                                        </div>
                                    </div>
                                </div>
                                <div class="btn-group">
                                    ${!config.is_active ? `
                                        <button class="btn btn-sm btn-outline-success" onclick="activateConfig(${config.id})">
                                            <i class="fas fa-check"></i> 激活
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteConfig(${config.id})">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            $('#configsList').html(html);
        }

        $('#createConfigForm').on('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                config_name: $('input[name="config_name"]').val(),
                new_media_weight: parseFloat($('input[name="new_media_weight"]').val()),
                info_commissioner_weight: parseFloat($('input[name="info_commissioner_weight"]').val()),
                description: $('textarea[name="description"]').val(),
                is_active: $('input[name="is_active"]').is(':checked')
            };

            $.ajax({
                url: '/api/weight_configs',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        alert('配置创建成功！');
                        $('#createConfigForm')[0].reset();
                        loadConfigs();
                        if (formData.is_active) {
                            location.reload(); // 重新加载以显示新的活跃配置
                        }
                    } else {
                        alert('创建失败: ' + response.message);
                    }
                },
                error: function() {
                    alert('创建失败，请重试');
                }
            });
        });

        function activateConfig(configId) {
            if (!confirm('确定要激活此配置吗？这将停用当前活跃的配置。')) {
                return;
            }

            $.ajax({
                url: `/api/weight_configs/${configId}/activate`,
                method: 'PUT',
                success: function(response) {
                    if (response.success) {
                        alert('配置已激活！');
                        location.reload();
                    } else {
                        alert('激活失败: ' + response.message);
                    }
                },
                error: function() {
                    alert('激活失败，请重试');
                }
            });
        }

        function deleteConfig(configId) {
            if (!confirm('确定要删除此配置吗？此操作不可恢复。')) {
                return;
            }

            $.ajax({
                url: `/api/weight_configs/${configId}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        alert('配置已删除');
                        loadConfigs();
                    } else {
                        alert('删除失败: ' + response.message);
                    }
                },
                error: function() {
                    alert('删除失败，请重试');
                }
            });
        }
    </script>
</body>
</html>